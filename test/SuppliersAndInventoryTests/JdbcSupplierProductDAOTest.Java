package Tests;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.math.BigDecimal;
import java.sql.SQLException;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import Suppliers.DTOs.SupplierProductDTO;
import Suppliers.DataLayer.DAOs.DataAccessException;
import Suppliers.DataLayer.DAOs.JdbcSupplierProductDAO;
import Suppliers.DataLayer.util.Database;

class JdbcSupplierProductDAOTest {
   private JdbcSupplierProductDAO dao;

   @BeforeEach
   void setUp() throws SQLException {
      dao = new JdbcSupplierProductDAO();
      Database.seedDefaultData();
   }

   @AfterEach
   void tearDown() throws SQLException {
      Database.deleteAllData();
   }

   @Test
   void insertAndFetchProduct_roundTrip() throws SQLException {
      // Arrange: assume supplier_id=1 already exists
      SupplierProductDTO toInsert = new SupplierProductDTO(
            /* supplierId = */ 1,
            /* productId = */ -1,
            /* supplierCatalogNumber = */ "CAT-001",
            /* name = */ "Test Widget",
            /* price = */ new BigDecimal("12.50"),
            /* weight = */ new BigDecimal("0.75"),
            /* expiresInDays = */ 30,
            /* manufacturerName = */ "AcmeMfg");

      // Act: insert & fetch
      SupplierProductDTO created = dao.createSupplierProduct(toInsert);
      assertNotNull(created, "Created product should not be null");
      assertTrue(created.getProductId() > 0, "Product ID must be autogenerated");

      Optional<SupplierProductDTO> fetchedOpt = dao.getSupplierProductById(1, created.getProductId());
      assertTrue(fetchedOpt.isPresent());
      SupplierProductDTO fetched = fetchedOpt.get();

      assertEquals("Test Widget", fetched.getName());
      assertEquals(new BigDecimal("12.5"), fetched.getPrice());

      // Also test getProductsBySupplierId
      List<SupplierProductDTO> bySupplier = dao.getAllSupplierProductsForSupplier(1);
      assertTrue(bySupplier.stream()
            .anyMatch(p -> p.getProductId() == created.getProductId()),
            "Should find the justâ€inserted product in getProductsBySupplierId(1)");
   }

   @Test
   void insertingNegativePrice_throwsSQLException() {
      // price has CHECK(price >= 0), so negative price should fail
      SupplierProductDTO bad = new SupplierProductDTO(
            /* supplierId = */ 1,
            /* productId = */ -1,
            /* catalog# */ "BAD-001",
            /* name = */ "Bad Widget",
            /* price = */ new BigDecimal("-1.00"),
            /* weight = */ new BigDecimal("1.00"),
            /* expiresInDays = */ 10,
            /* mfg = */ "AcmeMfg");

      assertThrows(DataAccessException.class, () -> dao.createSupplierProduct(bad),
            "Negative price should violate CHECK(price >= 0)");
   }
}